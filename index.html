document.getElementById('sendWishButton').addEventListener('click', async () => {
    const name = document.getElementById('name').value;
    const message = document.getElementById('message').value;
    const imageLink = document.getElementById('imageLink').value;

    if (!name || !message) {
        alert('กรุณากรอกชื่อและคำอวยพร');
        return;
    }

    if (!isDateValid()) {
        alert('ไม่สามารถส่งคำอวยพรได้ในวันนี้! กรุณาลองอีกครั้งในวันที่ 12 ตุลาคม 2567');
        return;
    }

    const userIP = await getUserIP(); 

    if (isRestricted(userIP)) {
        alert('IP ของคุณถูกจำกัด ไม่สามารถส่งคำอวยพรได้!');
        return;
    }

    if (hasAlreadySent(userIP)) {
        alert('คุณได้ส่งคำอวยพรไปแล้วครั้งหนึ่ง!');
        return;
    }

    const webhookUrl = 'https://discord.com/api/webhooks/1293134033974198315/QFBhnsIaLwY8JJGgozPfJccbWKWrnsHnWOEuXOq0QiUBt2ez6e0RASn4tFjwh4TJfOHP';
    const messagePayload = {
        content: `คำอวยพรใหม่จาก ${name}: ${message}\nลิงก์รูปภาพ: ${imageLink || 'ไม่มี'}\nIP ของผู้ส่ง: ${userIP}`,
        username: 'Birthday Wish',
        avatar_url: '',
        embeds: [{
            title: 'คำอวยพรวันเกิด',
            description: `${message}`,
            color: 16711680,
            footer: {
                text: `จาก: ${name}`
            },
            image: {
                url: imageLink || ''
            }
        }]
    };

    fetch(webhookUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(messagePayload)
    })
    .then(response => {
        if (response.ok) {
            alert('ส่งคำอวยพรเรียบร้อยแล้ว!');
            markAsSent(userIP);
        } else {
            alert('เกิดข้อผิดพลาดในการส่งคำอวยพร');
        }
    })
    .catch(error => {
        console.error('Error sending wish:', error);
        alert('เกิดข้อผิดพลาดในการส่งคำอวยพร');
    });
});
