const express = require('express');
const axios = require('axios');
const bodyParser = require('body-parser');

const app = express();
app.use(bodyParser.json());

const token = 'YOUR_PERSONAL_ACCESS_TOKEN'; // ใส่ Personal Access Token ของคุณที่นี่
const repoOwner = 'YOUR_GITHUB_USERNAME'; // ชื่อผู้ใช้ GitHub ของคุณ
const repoName = 'YOUR_REPO_NAME'; // ชื่อ repository ของคุณ
const filePath = 'wishes.json'; // ไฟล์ที่คุณต้องการอัปเดต

// ฟังก์ชันสำหรับอัปเดตไฟล์บน GitHub
async function updateFile(newWish) {
    try {
        // 1. ดึงข้อมูลไฟล์เดิม
        const { data: fileData } = await axios.get(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
            headers: {
                'Authorization': `token ${token}`
            }
        });

        // 2. แปลงข้อมูลจาก base64 เป็น string
        const content = Buffer.from(fileData.content, 'base64').toString('utf-8');
        const wishes = JSON.parse(content);

        // 3. เพิ่มคำอวยพรใหม่
        wishes.push(newWish);

        // 4. แปลงข้อมูลกลับเป็น base64
        const updatedContent = Buffer.from(JSON.stringify(wishes, null, 2)).toString('base64');

        // 5. อัปเดตไฟล์บน GitHub
        await axios.put(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
            message: 'Add new birthday wish',
            content: updatedContent,
            sha: fileData.sha // SHA ของไฟล์เดิม
        }, {
            headers: {
                'Authorization': `token ${token}`
            }
        });

        console.log('File updated successfully!');
    } catch (error) {
        console.error('Error updating file:', error);
    }
}

// สร้าง API สำหรับรับคำอวยพร
app.post('/update-wishes', async (req, res) => {
    const newWish = req.body;

    try {
        await updateFile(newWish);
        res.status(200).send('Wish updated successfully!');
    } catch (error) {
        res.status(500).send('Error updating wish.');
    }
});

// เริ่มเซิร์ฟเวอร์
const PORT = 3000;
app.listen(PORT, () => {
    console.log(`Server is running on http://localhost:${PORT}`);
});
